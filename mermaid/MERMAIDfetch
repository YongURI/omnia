#!/bin/sh
#
# Simple shell script to:
# 1) retrieve MERMAID data
# 2) write new SAC (.sac) files
# 3) write changepoint (.cp) files with uncertainty estimates
# 4) generate preliminary match to the seismic catalog and write
#    corresponding .evt and .pdf files
#
# Switches to master branch in MERMAID server, processed, and event
# directories before proceeding.
#
# No I/0 and requires internal editing as it was built for JDS' system
# defaults.
#
# Author: Joel D. Simon
# Contact: jdsimon@princeton.edu
# Last modified: 04-Oct-2019

# Keep track of starting directory.
start_dir=`pwd`

# Ensure you are in master (and not some dev) branch in the three relevant directories.
printf '\n\n!!!!! Switching to master branch in dirs $MERMAID: server, processed, and events !!!!!\n\n'

cd $MERMAID
cd server
git checkout master  >& /dev/null
cd ..

cd processed
git checkout master  >& /dev/null
cd ..

cd events
git checkout master  >& /dev/null
cd ..

# Pull most recent data.
echo -e 'Copying server...\n'
~/github/omnia/mermaid/servercopy > server_out
echo -e '\n...completed server copy\n'

# Exit if no new data.
nosac=$(grep 'nothing to commit' server_out | wc -l)
rm -f server_out
# if [ $nosac -eq 1 ]; then
#     echo -e '\nNo new files. Exiting MERMAIDfetch.'
#     exit;
# fi


# Generate SAC files.
echo -e 'Writing SAC files...\n'
source activate pymaid
python scripts/main.py
source deactivate
echo -e '\n...completed writing SAC files\n'

# Generate raw matches to the IRIS catalog.  Note that upon exiting
# MATLAB you may get the following message.
#
#    Identifier: 'MATLAB:connector:connector:ConnectorNotRunning'
#     Arguments: {}
#
# I have only noticed this since adding the parallel
# writechangepointall.m to matchall.m.  I assume it has something to
# do with MATLAB closing before the parallel pool is completely shut
# down.  Doesn't seem to affect the output of this code, however.
echo -e '\nMatching to the seismic catalog...\n'
/usr/local/MATLAB/R2017b/bin/matlab -r "run matchall.m; exit"

## 28-Jun-2019
## -nodisplay does not work with updated plotchangepoint.m, which sets
## -the interpreter to LaTeX, which MATLAB does not like unless the
## -GUI is opened interactively, unfortunately.
#/usr/local/MATLAB/R2017b/bin/matlab -nodisplay -r "run ~/github/omnia/mermaid/matchall.m; run exit"

# Display current count.
echo -e '\nHere is the complete list:\n'
$OMNIA/mermaid/countsac

# Return from whence you came.
/usr/bin/cd $start_dir
